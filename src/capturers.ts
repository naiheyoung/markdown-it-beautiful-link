import Token from 'markdown-it/lib/token.mjs'
import { createSpan, createSimpleToken } from './utils'
import type { Capturer } from './types'

const githubLinkRegex =
  /https?:\/\/github\.com(?:\/(?<user>[^\/\s#]+))?(?:\/(?<repo>[^\/\s#]+))?(?:\/(?<detail>[^\s]+))?/

/**
 * https?://github.com
 */
const captureGithubLink: Capturer = (link: string) => {
  if (!link) return []
  const match = link.match(githubLinkRegex)
  if (!match || !match.groups) return []

  const tokens: Token[] = []

  const { user, repo, detail } = match.groups
  const symbol = new Token('text', '', 0)
  symbol.content = '/'

  if (detail && repo)
    tokens.push(
      ...createSpan(
        'type',
        'repo',
        repo,
        createSimpleToken(
          '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" style="display: inline;"><path fill="currentColor" d="M5 18v3.766l1.515-.909L11.277 18H16c1.103 0 2-.897 2-2V8c0-1.103-.897-2-2-2H4c-1.103 0-2 .897-2 2v8c0 1.103.897 2 2 2zM4 8h12v8h-5.277L7 18.234V16H4z"/><path fill="currentColor" d="M20 2H8c-1.103 0-2 .897-2 2h12c1.103 0 2 .897 2 2v8c1.103 0 2-.897 2-2V4c0-1.103-.897-2-2-2"/></svg>',
          'html_inline'
        ),
        'before'
      ),
      symbol,
      ...createSpan('type', 'detail', detail)
    )
  else if (repo && user)
    tokens.push(
      ...createSpan(
        'type',
        'user',
        user,
        createSimpleToken(
          '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 32 32" style="display: inline;"><path fill="currentColor" d="m28.504 8.136l-12-7a1 1 0 0 0-1.008 0l-12 7A1 1 0 0 0 3 9v14a1 1 0 0 0 .496.864l12 7a1 1 0 0 0 1.008 0l12-7A1 1 0 0 0 29 23V9a1 1 0 0 0-.496-.864M16 3.158L26.016 9L16 14.842L5.984 9ZM5 10.74l10 5.833V28.26L5 22.426Zm12 17.52V16.574l10-5.833v11.685Z"/></svg>',
          'html_inline'
        ),
        'before'
      ),
      symbol,
      ...createSpan('type', 'repo', repo)
    )
  else if (user)
    tokens.push(
      ...createSpan(
        'type',
        'user',
        user,
        createSimpleToken(
          '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 32 32" style="display: inline;"><path fill="currentColor" d="M7 5.21a.77.77 0 0 1-.46-1.38A15.46 15.46 0 0 1 16 1c2.66 0 6.48.45 9.5 2.62a.77.77 0 0 1 .18 1.07a.78.78 0 0 1-1.08.17A15 15 0 0 0 16 2.53a14 14 0 0 0-8.5 2.52a.74.74 0 0 1-.5.16"/><path fill="currentColor" d="M28.23 12.26a.78.78 0 0 1-.63-.33C25.87 9.49 22.78 6.24 16 6.24a14 14 0 0 0-11.63 5.7a.77.77 0 0 1-1.07.17a.76.76 0 0 1-.15-1.11A15.54 15.54 0 0 1 16 4.71c5.61 0 9.81 2.08 12.84 6.34a.77.77 0 0 1-.19 1.07a.8.8 0 0 1-.42.14"/><path fill="currentColor" d="M12.28 31a.78.78 0 0 1-.72-.49a.75.75 0 0 1 .44-1c4.37-1.68 7-5.12 7-9.21a2.8 2.8 0 0 0-3-3c-1.86 0-2.76 1-3 3.35a4.27 4.27 0 0 1-4.52 3.83a4.27 4.27 0 0 1-4.32-4.59A11.71 11.71 0 0 1 16 8.39a12 12 0 0 1 12 11.93a18.7 18.7 0 0 1-1.39 6.5a.78.78 0 0 1-1 .41a.76.76 0 0 1-.41-1a17.3 17.3 0 0 0 1.27-5.91A10.45 10.45 0 0 0 16 9.92a10.18 10.18 0 0 0-10.38 10a2.77 2.77 0 0 0 2.79 3.06a2.74 2.74 0 0 0 3-2.48c.36-3.11 1.89-4.69 4.56-4.69a4.31 4.31 0 0 1 4.52 4.56c0 4.74-3 8.72-8 10.63a1 1 0 0 1-.21 0"/><path fill="currentColor" d="M19.77 30.28a.8.8 0 0 1-.52-.2a.76.76 0 0 1 0-1.08a12.63 12.63 0 0 0 3.54-8.68c0-1.56-.48-6.65-6.7-6.65a6.83 6.83 0 0 0-4.94 1.87A6.17 6.17 0 0 0 9.32 20a.77.77 0 0 1-.77.76a.76.76 0 0 1-.77-.76A7.73 7.73 0 0 1 10 14.46a8.34 8.34 0 0 1 6-2.32c6.08 0 8.24 4.4 8.24 8.18a14.1 14.1 0 0 1-3.9 9.68a.75.75 0 0 1-.57.28"/><path fill="currentColor" d="M8.66 27.74a14 14 0 0 1-1.56-.09a.76.76 0 1 1 .17-1.52c2.49.28 4.45-.16 5.84-1.32a6.37 6.37 0 0 0 2.12-4.53a.75.75 0 0 1 .82-.71a.78.78 0 0 1 .72.81A7.9 7.9 0 0 1 14.09 26a8.2 8.2 0 0 1-5.43 1.74"/></svg>',
          'html_inline'
        ),
        'before'
      )
    )

  if (tokens.length <= 0) {
    tokens.push(
      ...createSpan(
        '',
        '',
        'github',
        createSimpleToken(
          '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 32 32" style="display: inline;"><path fill="currentColor" fill-rule="evenodd" d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.7 3.7 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45a3 3 0 0 0 4.08 1.16a2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76a5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7a5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2"/></svg>',
          'html_inline'
        ),
        'before'
      )
    )
  }
  return tokens
}

/**
 * https?://unocss.dev
 */
const captureUnocssLink: Capturer = (link: string) => {
  if (!link) return []

  return createSpan(
    '',
    '',
    'unocss',
    createSimpleToken(
      '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 256" style="display: inline;"><path fill="#858585" d="M137.176 195.927c0-32.813 26.6-59.412 59.412-59.412S256 163.114 256 195.927c0 32.812-26.6 59.412-59.412 59.412s-59.412-26.6-59.412-59.412"/><path fill="#CCC" d="M137.176 59.412C137.176 26.6 163.776 0 196.588 0S256 26.6 256 59.412v53.471c0 3.28-2.66 5.941-5.941 5.941H143.117a5.94 5.94 0 0 1-5.941-5.94z"/><path fill="#4D4D4D" d="M118.824 195.927c0 32.812-26.6 59.412-59.412 59.412S0 228.74 0 195.927v-53.47a5.94 5.94 0 0 1 5.941-5.942h106.942a5.94 5.94 0 0 1 5.941 5.941z"/></svg>',
      'html_inline'
    ),
    'before'
  )
}

/**
 * https?://shiki.style
 */
const captureShikiLink: Capturer = (link: string) => {
  if (!link) return []

  return createSpan(
    '',
    '',
    'shiki',
    createSimpleToken(
      '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 266 266" fill="none" style="display: inline;"><g><circle cx="219.5" cy="46.5" r="46.5" fill="#CB7676"/><rect y="48" width="266" height="65" fill="#4B9978"/><path d="M109.463 144.426C109.012 138.792 106.899 134.397 103.124 131.242C99.4052 128.086 93.7426 126.509 86.1361 126.509C81.2905 126.509 77.3182 127.1 74.2192 128.284C71.1766 129.411 68.9228 130.96 67.4579 132.932C65.9929 134.904 65.2323 137.158 65.1759 139.693C65.0632 141.778 65.4295 143.666 66.2747 145.356C67.1762 146.99 68.5848 148.483 70.5005 149.835C72.4162 151.131 74.8672 152.315 77.8535 153.385C80.8397 154.456 84.3894 155.414 88.5026 156.259L102.701 159.301C112.28 161.33 120.478 164.006 127.296 167.33C134.113 170.655 139.692 174.571 144.03 179.078C148.369 183.529 151.552 188.544 153.58 194.122C155.665 199.7 156.736 205.785 156.792 212.378C156.736 223.759 153.89 233.394 148.256 241.283C142.621 249.171 134.564 255.171 124.084 259.285C113.66 263.398 101.124 265.454 86.4742 265.454C71.4302 265.454 58.3019 263.229 47.0893 258.778C35.9331 254.326 27.2561 247.48 21.0582 238.24C14.9166 228.943 11.8177 217.054 11.7613 202.574H56.3862C56.6679 207.87 57.992 212.321 60.3585 215.928C62.725 219.534 66.0493 222.266 70.3315 224.126C74.67 225.985 79.8255 226.915 85.798 226.915C90.8127 226.915 95.0104 226.295 98.391 225.055C101.772 223.816 104.335 222.097 106.082 219.9C107.829 217.702 108.73 215.195 108.787 212.378C108.73 209.73 107.857 207.419 106.167 205.447C104.533 203.419 101.828 201.616 98.053 200.038C94.2779 198.404 89.1787 196.883 82.7554 195.474L65.514 191.756C50.1883 188.431 38.1024 182.881 29.2563 175.106C20.4666 167.274 16.0999 156.597 16.1562 143.074C16.0999 132.087 19.0298 122.48 24.946 114.254C30.9185 105.971 39.1729 99.5197 49.7094 94.8995C60.3021 90.2793 72.4444 87.9691 86.1361 87.9691C100.11 87.9691 112.195 90.3074 122.394 94.984C132.592 99.6606 140.452 106.253 145.974 114.761C151.552 123.213 154.369 133.101 154.426 144.426H109.463Z" fill="#83D0DA"/><rect x="217" width="266" height="65" transform="rotate(90 217 0)" fill="#E6CC78"/></g></svg>',
      'html_inline'
    ),
    'before'
  )
}

/**
 * https?://npmjs.com
 */
const captureNpmjsLink: Capturer = (link: string) => {
  if (!link) return []

  return createSpan(
    '',
    '',
    'npmjs',
    createSimpleToken(
      '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 287" style="display: inline;"><path d="M7.964 72.363L129.707 1.479l121.742 70.884v141.653L129.707 284.9L7.964 214.016V72.363z" fill="#C00"/><path d="M133.12 143.132l113.209-65.194l4.551 131.413l-117.76 71.111v-137.33z" fill="#FFF"/><path d="M248.036 73.956l-.342 139.264l-118.101 68.494l-.569-136.875l119.012-70.883zm-99.328 82.26l.34 91.478l39.254-22.87l-.114-68.948l19.798-11.72v69.177l19.797-11.605l.114-92.615l-79.19 47.104z" fill="#C00"/><path d="M137.444 2.503c-5.462-3.072-14.223-3.072-19.684 0L9.899 64.512C4.437 67.584.114 75.321.114 81.465v124.018c0 6.257 4.437 13.88 9.785 16.953l107.861 62.008c5.461 3.072 14.222 3.072 19.684 0l107.86-62.008c5.462-3.072 9.786-10.81 9.786-16.953V81.465c0-6.258-4.438-13.881-9.785-16.953L137.444 2.503zm95.687 64.853c5.461 3.072 5.461 8.192 0 11.264l-94.436 54.272c-5.461 3.072-14.222 3.072-19.683 0L23.21 77.824c-5.462-3.072-5.462-8.192 0-11.264l94.435-54.272c5.462-3.072 14.222-3.072 19.684 0l95.8 55.068zM8.533 90.453c0-6.257 4.438-8.76 9.785-5.689l96.598 55.524c5.46 3.072 9.784 10.809 9.784 16.953v110.137c0 6.258-4.437 8.76-9.784 5.689l-96.598-55.524c-5.461-3.072-9.785-10.809-9.785-16.953V90.453zm134.6 180.907c-5.462 3.072-9.785.569-9.785-5.689v-108.43c0-6.258 4.437-13.881 9.784-16.953l93.753-53.817c5.462-3.072 9.785-.569 9.785 5.689v108.43c0 6.258-4.437 13.881-9.785 16.953l-93.753 53.817z" fill="#910505"/></svg>',
      'html_inline'
    ),
    'before'
  )
}

/**
 * https?://pnpm.io
 */
const capturePnpmLink: Capturer = (link: string) => {
  if (!link) return []

  return createSpan(
    '',
    '',
    'pnpm',
    createSimpleToken(
      '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 512 368" style="display: inline;"><path fill="#F9AD00" d="M512 126.274v114.794H397.206V126.274zM512 0v114.794H397.206V0zM385.726 0v114.794H270.932V0zM259.452 0v114.794H144.658V0z"/><path fill="#4E4E4E" d="M385.726 252.548v114.794H270.932V252.548zm126.274 0v114.794H397.206V252.548zm-252.548 0v114.794H144.658V252.548zm126.274-126.274v114.794H270.932V126.274zM21.503 159.77q5.785 0 10.752 1.494q4.965 1.496 8.534 4.58q3.568 3.086 5.593 7.763t2.025 11.138q-.001 6.171-1.736 10.8q-1.736 4.628-4.918 7.762t-7.666 4.676t-9.98 1.543q-4.147 0-7.714-1.253v16.007l-.156.044q-.972.27-2.93.582q-2.12.338-4.34.338q-2.12 0-3.808-.29q-1.687-.288-2.845-1.156q-1.157-.868-1.735-2.363Q0 219.942 0 217.531v-46.285l.005-.343q.069-2.37 1.104-3.9q1.11-1.64 3.037-2.99q2.99-1.928 7.425-3.085q4.436-1.157 9.932-1.157m112.627 0q5.785 0 10.752 1.494q4.965 1.496 8.534 4.58q3.568 3.086 5.593 7.763t2.025 11.138q0 6.171-1.736 10.8q-1.736 4.628-4.918 7.762t-7.666 4.676t-9.98 1.543q-4.147 0-7.714-1.253v16.007l-.155.044q-.973.27-2.931.582q-2.12.338-4.34.338q-2.12 0-3.808-.29q-1.687-.288-2.845-1.156q-1.157-.868-1.735-2.363q-.579-1.494-.579-3.905v-46.285l.005-.343q.069-2.37 1.104-3.9q1.11-1.64 3.037-2.99q2.99-1.928 7.425-3.085q4.436-1.157 9.932-1.157m-54.288 0q10.896 0 16.778 4.773t5.882 13.259v30.181l-.168.049q-.969.264-2.87.53q-2.072.29-4.29.29q-2.122 0-3.81-.29q-1.686-.29-2.844-1.157q-1.157-.868-1.784-2.363q-.627-1.494-.626-3.905v-22.757l-.005-.31q-.084-2.752-1.683-4.077q-1.688-1.398-4.58-1.398q-1.929 0-3.81.482q-1.88.481-3.23 1.446v33.46l-.168.049q-.969.264-2.869.53q-2.073.29-4.29.29q-2.123 0-3.81-.29t-2.844-1.157t-1.784-2.363q-.627-1.494-.627-3.905V172.21l.005-.343q.069-2.37 1.104-3.9q1.11-1.64 3.037-2.99q3.279-2.313 8.245-3.76t11.04-1.446m141.266 0q3.664 0 7.184.964t6.267 3.038q2.749 2.073 4.388 5.496q1.64 3.423 1.64 8.34v30.375l-.17.049q-.968.264-2.868.53q-2.073.29-4.291.29q-2.122 0-3.81-.29q-1.686-.29-2.844-1.157q-1.157-.868-1.784-2.363q-.627-1.494-.627-3.905v-23.046l-.005-.316q-.086-2.649-1.634-3.879q-1.64-1.3-4.435-1.301q-1.35 0-2.893.626q-1.543.627-2.315 1.302q.097.386.097.723v32.737l-.184.049q-1.05.264-2.95.53q-2.073.29-4.195.29q-2.12 0-3.808-.29t-2.845-1.157t-1.784-2.363q-.627-1.494-.627-3.905v-23.046l-.005-.3q-.088-2.66-1.779-3.895q-1.784-1.3-4.29-1.301q-1.737 0-2.99.53t-2.121 1.013v33.845l-.169.049q-.968.264-2.869.53q-2.073.29-4.29.29q-2.123 0-3.81-.29t-2.844-1.157t-1.784-2.363q-.627-1.494-.627-3.905v-29.12l.005-.343q.069-2.364 1.104-3.804q1.11-1.543 3.037-2.893q3.279-2.314 8.149-3.76q4.869-1.447 10.173-1.447q3.953 0 7.762 1.109q3.81 1.109 6.605 3.326q2.893-1.928 6.51-3.182q3.615-1.253 8.726-1.253M22.082 172.596q-1.832 0-3.279.434q-1.446.433-2.507 1.012v21.214l.391.188q.991.455 2.116.776q1.35.386 2.893.386q9.932 0 9.932-11.86q0-6.172-2.459-9.161q-2.458-2.99-7.087-2.99m112.627 0q-1.832 0-3.279.434q-1.446.433-2.507 1.012v21.214l.391.188q.991.455 2.116.776q1.35.386 2.893.386q9.933 0 9.932-11.86q0-6.172-2.459-9.161q-2.458-2.99-7.087-2.99"/></svg>',
      'html_inline'
    ),
    'before'
  )
}

/**
 * https?://vite.dev
 */
const captureVitejsLink: Capturer = (link: string) => {
  if (!link) return []

  return createSpan(
    '',
    '',
    'vite',
    createSimpleToken(
      '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 257" style="display: inline;"><defs><linearGradient id="SVGmrugVdcL" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"/><stop offset="100%" stop-color="#BD34FE"/></linearGradient><linearGradient id="SVGqn4NsbfA" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"/><stop offset="8.333%" stop-color="#FFDD35"/><stop offset="100%" stop-color="#FFA800"/></linearGradient></defs><path fill="url(#SVGmrugVdcL)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.5 6.5 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62"/><path fill="url(#SVGqn4NsbfA)" d="M185.432.063L96.44 17.501a3.27 3.27 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113"/></svg>',
      'html_inline'
    ),
    'before'
  )
}

export {
  captureGithubLink,
  captureUnocssLink,
  captureShikiLink,
  captureNpmjsLink,
  capturePnpmLink,
  captureVitejsLink
}
